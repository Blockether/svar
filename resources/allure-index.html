<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Test Reports ¬∑ spel</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé≠</text></svg>">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #f8f9fb; --bg-card: #fff; --bg-card-hover: #f6f7f9;
      --border: #e2e5ea; --border-hover: #cdd1d8;
      --text: #1a1d23; --text-sec: #5a6070; --text-muted: #8b92a0;
      --green: #2EAD33; --green-bg: rgba(46,173,51,0.06); --green-border: rgba(46,173,51,0.2);
      --green-text: #1d7a22; --red: #d94040; --red-bg: rgba(217,64,64,0.05); --red-border: rgba(217,64,64,0.2);
      --red-text: #b33030; --code-bg: #eef0f4; --code-text: #5a6070;
      --yellow: #d4a017; --yellow-bg: rgba(255,193,7,0.06); --yellow-border: rgba(255,193,7,0.3);
      --purple: #7c3aed; --purple-bg: rgba(124,58,237,0.06); --purple-border: rgba(124,58,237,0.2); --purple-text: #6d28d9;
      --shadow: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-h: 0 3px 8px rgba(0,0,0,0.07), 0 1px 2px rgba(0,0,0,0.04);
    }
    html.dark {
      --bg: #0f1219; --bg-card: #1a2030; --bg-card-hover: #1f2738;
      --border: #2a3142; --border-hover: #3a4358;
      --text: #e8eaf0; --text-sec: #9ba3b5; --text-muted: #5f6880;
      --green-bg: rgba(46,173,51,0.08); --green-border: rgba(46,173,51,0.25);
      --green-text: #4cd952; --red-bg: rgba(217,64,64,0.08); --red-border: rgba(217,64,64,0.25);
      --red-text: #f06060; --code-bg: #252d3d; --code-text: #9ba3b5;
      --yellow-bg: rgba(255,193,7,0.08); --yellow-border: rgba(255,193,7,0.35);
      --purple-bg: rgba(124,58,237,0.08); --purple-border: rgba(124,58,237,0.25); --purple-text: #a78bfa;
      --shadow: 0 1px 2px rgba(0,0,0,0.2); --shadow-h: 0 4px 12px rgba(0,0,0,0.3);
    }
    body { font-family: system-ui, -apple-system, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }
    @keyframes fade-in { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

    /* --- Header --- */
    .header { padding: 1.25rem 1rem 0.75rem; text-align: center; }
    .logo { width: 56px; height: 56px; margin: 0 auto; opacity: 0.9; }
    .logo svg { width: 100%; height: 100%; }
    .title { font-family: 'Iowan Old Style', 'Palatino Linotype', Palatino, Georgia, serif; font-size: 1.6rem; font-weight: 700; letter-spacing: 0.05em; margin-bottom: 0.15rem; }
    .subtitle { font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.15em; text-transform: uppercase; }

    /* --- Main container --- */
    .main { max-width: 95rem; margin: 0 auto; padding: 0.5rem 1.5rem 3rem; }

    /* --- Builds list (default = list view) --- */
    .builds { display: flex; flex-direction: column; gap: 0.3rem; max-width: 56rem; margin: 0 auto; }

    /* --- Date groups --- */
    .date-group { font-size: 0.65rem; font-weight: 600; color: var(--text-muted); letter-spacing: 0.06em; text-transform: uppercase; padding: 0.6rem 0.25rem 0.3rem; border-bottom: 1px solid var(--border); margin-top: 0.4rem; }
    .date-group:first-child { margin-top: 0; }

    /* --- Card (list view) --- */
    .card {
      display: flex; align-items: center; gap: 0.65rem;
      padding: 0.5rem 0.9rem 0.5rem 0;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
      border-left: 3px solid var(--green);
      background: var(--bg-card);
      box-shadow: var(--shadow);
      text-decoration: none; color: inherit;
      transition: border-color 0.15s, background 0.15s, box-shadow 0.15s, transform 0.15s;
      animation: fade-in 0.3s ease-out both;
      cursor: pointer;
    }
    .card:hover { border-color: var(--border-hover); border-left-color: var(--green); background: var(--bg-card-hover); box-shadow: var(--shadow-h); transform: translateY(-1px); }
    .card.pr { border-left-color: var(--purple); }
    .card.pr:hover { border-color: var(--purple-border); border-left-color: var(--purple); }
    .card.failed { border-left-color: var(--red); background: var(--red-bg); }
    .card.failed:hover { border-color: var(--red-border); border-left-color: var(--red); }
    .card.in-progress { border-left-color: var(--yellow); background: var(--yellow-bg); }
    .card.in-progress:hover { border-color: var(--yellow-border); border-left-color: var(--yellow); }
    html.dark .card.in-progress { background: var(--yellow-bg); }

    /* --- Run area (inline: number + status) --- */
    .run { flex-shrink: 0; display: flex; align-items: center; gap: 0.2rem; padding-left: 0.75rem; min-width: 3.5rem; }
    .run-label { display: none; }
    .run-num { font-size: 1.05rem; font-weight: 700; font-variant-numeric: tabular-nums; color: var(--text); line-height: 1; }
    a.run-link { text-decoration: none; color: var(--text); transition: color 0.15s; }
    a.run-link:hover { color: var(--green); }
    .card.pr a.run-link:hover { color: var(--purple); }
    .status-dot { flex-shrink: 0; font-size: 0.65rem; font-weight: 700; line-height: 1; }
    .status-pass { color: var(--green); }
    .status-fail { color: var(--red); }
    .status-in-progress { color: var(--yellow); }
    .divider { display: none; }

    /* --- Info --- */
    .info { flex: 1; min-width: 0; }
    .info-top { display: flex; align-items: center; gap: 0.3rem; margin-bottom: 0.1rem; flex-wrap: wrap; }
    .sha { display: inline-block; padding: 0.1rem 0.35rem; border-radius: 0.2rem; font-size: 0.65rem; font-family: 'SF Mono', 'Fira Code', Consolas, monospace; background: var(--code-bg); color: var(--code-text); line-height: 1.3; }
    .sha-link { text-decoration: none; transition: background 0.15s, color 0.15s; }
    .sha-link:hover { background: var(--border-hover); color: var(--text); }
    .failed .sha { background: var(--red-bg); color: var(--red-text); }
    .failed .sha-link:hover { background: var(--red-border); color: var(--red-text); }
    .msg { font-size: 0.78rem; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.35; }
    .author { margin: 0.05rem 0 0; font-size: 0.68rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* --- Meta (date/time) --- */
    .meta { flex-shrink: 0; text-align: right; }
    .meta-date { font-size: 0.65rem; color: var(--text-muted); font-variant-numeric: tabular-nums; line-height: 1.3; }
    .meta-rel { font-size: 0.58rem; color: var(--text-muted); opacity: 0.7; font-variant-numeric: tabular-nums; }
    .arrow { display: none; }

    /* --- Pills / badges --- */
    .pill { display: inline-block; padding: 1px 6px; border-radius: 10px; font-size: 0.58rem; font-weight: 600; letter-spacing: 0.02em; border: 1px solid; vertical-align: middle; }
    .pill-green { background: var(--green-bg); color: var(--green-text); border-color: var(--green-border); }
    .pill-yellow { background: rgba(255,193,7,0.10); color: #8a6d00; border-color: rgba(255,193,7,0.4); }
    .pill-blue { background: rgba(0,126,198,0.08); color: #006bb3; border-color: rgba(0,126,198,0.3); }
    .pill-red { background: var(--red-bg); color: var(--red-text); border-color: var(--red-border); }
    .pill-purple { background: var(--purple-bg); color: var(--purple-text); border-color: var(--purple-border); }
    html.dark .pill-yellow { background: rgba(255,193,7,0.12); color: #ffd54f; border-color: rgba(255,193,7,0.35); }
    html.dark .pill-blue { background: rgba(0,126,198,0.12); color: #64b5f6; border-color: rgba(0,126,198,0.35); }
    html.dark .pill-purple { background: rgba(124,58,237,0.12); color: #c4b5fd; border-color: rgba(124,58,237,0.35); }
    .pill-in-progress { background: rgba(255,193,7,0.12); color: #8a6d00; border-color: rgba(255,193,7,0.4); animation: pulse 2s infinite; }
    html.dark .pill-in-progress { background: rgba(255,193,7,0.15); color: #ffd54f; border-color: rgba(255,193,7,0.4); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

    /* --- Empty state --- */
    .empty { display: none; text-align: center; color: var(--text-muted); margin-top: 4rem; font-size: 1rem; }
    .empty.show { display: block; }

    /* --- Footer --- */
    .footer { text-align: center; padding-bottom: 2rem; font-size: 0.7rem; color: var(--text-muted); }
    .footer a { color: var(--text-sec); text-decoration: none; transition: color 0.15s; }
    .footer a:hover { color: var(--green); }


    /* --- Stats bar --- */
    .stats-bar { max-width: 56rem; margin: 0 auto 0.75rem; display: none; }
    .stats-bar.show { display: block; }
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 0.5rem; }
    .stat-block { background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.55rem 0.7rem; box-shadow: var(--shadow); }
    .stat-label { font-size: 0.5rem; font-weight: 600; color: var(--text-muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.15rem; }
    .stat-value { font-size: 1rem; font-weight: 700; color: var(--text); line-height: 1.2; font-variant-numeric: tabular-nums; }
    .stat-detail { font-size: 0.6rem; color: var(--text-sec); margin-top: 0.1rem; font-variant-numeric: tabular-nums; }
    .stat-pct { font-weight: 600; }
    .stat-pct.good { color: var(--green-text); }
    .stat-pct.mid { color: var(--yellow); }
    .stat-pct.low { color: var(--red-text); }
    .contributors { background: var(--bg-card); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.55rem 0.7rem; box-shadow: var(--shadow); }
    .contrib-title { font-size: 0.5rem; font-weight: 600; color: var(--text-muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 0.3rem; }
    .contrib-row { display: flex; align-items: center; gap: 0.5rem; padding: 0.2rem 0; font-variant-numeric: tabular-nums; }
    .contrib-row + .contrib-row { border-top: 1px solid var(--border); }
    .contrib-name { font-size: 0.75rem; font-weight: 600; color: var(--text); }
    .contrib-sep { color: var(--text-muted); font-size: 0.55rem; }
    .contrib-detail { font-size: 0.65rem; color: var(--text-sec); }
    .contrib-streak { font-size: 0.65rem; font-weight: 600; color: var(--green-text); }
    @media (max-width: 640px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .stats-bar { margin-bottom: 0.5rem; }
      .contrib-row { flex-wrap: wrap; gap: 0.25rem; }
    }

    /* --- Theme toggle --- */
    .theme-toggle { position: fixed; top: 1rem; right: 1rem; width: 2rem; height: 2rem; border-radius: 50%; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-sec); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; z-index: 50; box-shadow: var(--shadow); }
    .theme-toggle:hover { border-color: var(--border-hover); background: var(--bg-card-hover); }
    .theme-toggle svg { width: 1rem; height: 1rem; }
    .theme-toggle .icon-moon { display: none; }
    html.dark .theme-toggle .icon-sun { display: none; }
    html.dark .theme-toggle .icon-moon { display: block; }

    /* --- Video modal --- */
    .video-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; }
    .video-modal.show { display: flex; }
    .video-modal-content { max-width: 90vw; max-height: 90vh; position: relative; }
    .video-modal video { max-width: 100%; max-height: 85vh; border-radius: 8px; background: #000; }
    .video-modal-close { position: absolute; top: -40px; right: 0; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; }
    .video-modal-title { position: absolute; bottom: 20px; left: 20px; right: 60px; color: #fff; font-size: 0.9rem; background: rgba(0,0,0,0.6); padding: 0.5rem 1rem; border-radius: 4px; }

    /* --- View toggle --- */
    .view-toggle { position: fixed; top: 1rem; right: 3.25rem; display: flex; gap: 2px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 2px; z-index: 50; box-shadow: var(--shadow); }
    .view-btn { width: 2rem; height: 2rem; border: none; background: transparent; color: var(--text-muted); cursor: pointer; border-radius: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
    .view-btn:hover { color: var(--text-sec); background: var(--bg-card-hover); }
    .view-btn.active { background: var(--green-bg); color: var(--green-text); }
    .view-btn svg { width: 1rem; height: 1rem; }

    /* --- Mobile: list view --- */
    @media (max-width: 640px) {
      .meta { display: none; }
      .card { padding: 0.45rem 0.75rem 0.45rem 0; gap: 0.5rem; }
      .run { padding-left: 0.5rem; min-width: 2.75rem; }
      .run-num { font-size: 0.95rem; }
      .info-top { flex-wrap: wrap; gap: 4px; align-items: flex-start; }
      .pill { margin-left: 0; }
    }

    /* ================================================================
       Grid view ‚Äî square cards in wider multi-column layout
       ================================================================ */
    .builds.grid {
      max-width: none;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 0.75rem;
    }
    .builds.grid .date-group {
      grid-column: 1 / -1;
      font-size: 0.6rem; padding: 0.5rem 0.15rem 0.25rem; margin-top: 0.25rem;
    }
    .builds.grid .card {
      flex-direction: column; align-items: stretch;
      padding: 0.75rem 0.85rem 0.75rem 0.65rem;
      border-left-width: 3px;
      position: relative;
      aspect-ratio: 1 / 1;
      min-height: 0;
    }
    .builds.grid .run {
      width: 100%; justify-content: flex-start;
      padding-left: 0.6rem; margin-bottom: 0.2rem;
    }
    .builds.grid .run-num { font-size: 0.95rem; }
    .builds.grid .status-dot { font-size: 0.65rem; }
    .builds.grid .info { width: 100%; flex: 1; display: flex; flex-direction: column; }
    .builds.grid .info-top { margin-bottom: 0.15rem; gap: 0.3rem; flex-wrap: wrap; }
    .builds.grid .sha { padding: 2px 6px; font-size: 0.6rem; }
    .builds.grid .pill { font-size: 0.52rem; padding: 2px 6px; }
    .builds.grid .msg {
      font-size: 0.7rem;
      line-height: 1.4;
      white-space: normal;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      flex: 1;
      margin-bottom: 0.1rem;
    }
    .builds.grid .author { font-size: 0.6rem; margin: 0.1rem 0 0.15rem; }
    .builds.grid .meta {
      position: static;
      margin-top: auto;
      text-align: left;
      padding-top: 0.25rem;
      border-top: 1px solid var(--border);
    }
    .builds.grid .meta-date { font-size: 0.55rem; }
    .builds.grid .meta-rel { font-size: 0.5rem; }
    /* --- Tablet: grid view (3 columns) --- */
    @media (max-width: 1024px) {
      .builds.grid { grid-template-columns: repeat(3, 1fr); }
    }

    /* --- Mobile: grid view (2 columns) --- */
    @media (max-width: 640px) {
      .main { max-width: 100%; padding: 0.5rem 1rem 3rem; }
      .view-toggle { top: 0.75rem; right: 3.75rem; }
      .builds.grid { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
      .builds.grid .meta-date { font-size: 0.5rem; }
      .builds.grid .meta-rel { display: none; }
      .builds.grid .card { padding: 0.6rem 0.7rem 0.6rem 0.55rem; aspect-ratio: auto; }
      .builds.grid .run { padding-left: 0.45rem; }
      .builds.grid .msg { -webkit-line-clamp: 2; }
    }
  </style>
</head>
<body>
  <div class="view-toggle">
    <button class="view-btn active" id="viewList" onclick="setView('list')" title="List view">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="4" y1="7" x2="20" y2="7"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="17" x2="20" y2="17"/></svg>
    </button>
    <button class="view-btn" id="viewGrid" onclick="setView('grid')" title="Grid view">
      <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>
    </button>
  </div>
  <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
    <svg class="icon-sun" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
    <svg class="icon-moon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
  </button>

  <header class="header">
    <div class="logo"><!--LOGO_PLACEHOLDER--></div>
    <h1 class="title"><!--TITLE_PLACEHOLDER-->spel<!--/TITLE_PLACEHOLDER--></h1>
    <p class="subtitle"><!--SUBTITLE_PLACEHOLDER-->Clojure √ó Playwright ¬∑ Test Reports<!--/SUBTITLE_PLACEHOLDER--></p>
  </header>

  <main class="main">
    <div id="stats" class="stats-bar"></div>
    <div id="builds" class="builds"></div>
    <p id="empty" class="empty">No reports yet. Push to main to generate one.</p>
  </main>

  <!-- Video Modal -->
  <div id="videoModal" class="video-modal" onclick="if(event.target === this) closeVideoModal()">
    <div class="video-modal-content">
      <button class="video-modal-close" onclick="closeVideoModal()" title="Close">&times;</button>
      <video id="videoPlayer" controls playsinline></video>
      <div id="videoModalTitle" class="video-modal-title"></div>
    </div>
  </div>

  <footer class="footer">
    Powered by <a href="https://github.com/Blockether/spel">spel</a>
    &middot; Reports by <a href="https://allurereport.org">Allure</a>
  </footer>

  <script>
    // --- localStorage scoping by report path + 30-day auto-cleanup ---
    (function() {
      var THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;
      var prefix = location.pathname.replace(/\/[^/]*$/, '/') + ':';
      var cleanKey = prefix + '__lastCleaned';

      // Auto-cleanup: clear scoped keys older than 30 days
      try {
        var lastCleaned = parseInt(localStorage.getItem(cleanKey), 10);
        if (!lastCleaned || (Date.now() - lastCleaned) > THIRTY_DAYS) {
          for (var i = localStorage.length - 1; i >= 0; i--) {
            var k = localStorage.key(i);
            if (k && k.indexOf(prefix) === 0) localStorage.removeItem(k);
          }
          localStorage.setItem(cleanKey, String(Date.now()));
        }
      } catch(e) {}

      // Scoped wrappers
      var _getItem = localStorage.getItem.bind(localStorage);
      var _setItem = localStorage.setItem.bind(localStorage);
      var _removeItem = localStorage.removeItem.bind(localStorage);

      window.__spelGetItem = function(key) { return _getItem(prefix + key); };
      window.__spelSetItem = function(key, val) { _setItem(prefix + key, val); };
      window.__spelRemoveItem = function(key) { _removeItem(prefix + key); };
    })();
    (function() {
      // Theme is stored globally (shared across all builds)
      var saved = localStorage.getItem('spel-theme');
      if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches))
        document.documentElement.classList.add('dark');
    })();
    function toggleTheme() {
      var d = document.documentElement.classList.toggle('dark');
      localStorage.setItem('spel-theme', d ? 'dark' : 'light');
    }

    // View mode toggle (persisted in localStorage)
    // Migrate old mode names: columns‚Üílist, compact‚Üígrid
    function setView(mode) {
      if (mode === 'columns') mode = 'list';
      if (mode === 'compact') mode = 'grid';
      localStorage.setItem('spel-view', mode);
      document.getElementById('viewList').classList.toggle('active', mode === 'list');
      document.getElementById('viewGrid').classList.toggle('active', mode === 'grid');
      document.getElementById('builds').classList.toggle('grid', mode === 'grid');
    }
    (function() {
      var view = localStorage.getItem('spel-view') || 'list';
      setView(view);
    })();

    // Video modal functions
    function openVideoModal(src, title) {
      var modal = document.getElementById('videoModal');
      var player = document.getElementById('videoPlayer');
      var titleEl = document.getElementById('videoModalTitle');
      player.src = src;
      titleEl.textContent = title || 'Video Recording';
      modal.classList.add('show');
      player.play();
    }
    function closeVideoModal() {
      var modal = document.getElementById('videoModal');
      var player = document.getElementById('videoPlayer');
      player.pause();
      player.src = '';
      modal.classList.remove('show');
    }
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeVideoModal();
    });

    function relativeTime(ts) {
      var diff = Date.now() - ts, m = Math.floor(diff / 60000);
      if (m < 1) return 'just now';
      if (m < 60) return m + 'm ago';
      var h = Math.floor(m / 60);
      if (h < 24) return h + 'h ago';
      var d = Math.floor(h / 24);
      return d < 30 ? d + 'd ago' : null;
    }
    function formatDate(ts) {
      if (!ts) return '';
      var d = new Date(ts);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
        + ' ' + d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
    }
    function truncate(s, n) {
      if (!s) return '';
      var f = s.split('\n')[0];
      return f.length > n ? f.slice(0, n) + '\u2026' : f;
    }

    function renderBuild(b, i) {
      var sha = (b.sha || '').slice(0, 8);
      var fullSha = b.sha || '';
      var repoUrl = b.repo_url || '';
      var runUrl = b.run_url || '';
      var msg = truncate(b.message, 80);
      var author = b.author || '';
      var date = b.timestamp ? formatDate(b.timestamp) : '';
      var rel = b.timestamp ? relativeTime(b.timestamp) : '';
      var delay = Math.min(i, 9) * 0.04;
      var inProgress = b.status === 'in_progress';
      var failed = !inProgress && b.passed === false;
      var isPR = b.type === 'pr';
      var cardClass = 'card' + (isPR ? ' pr' : '') + (failed ? ' failed' : '') + (inProgress ? ' in-progress' : '');

      var shaHtml = '';
      if (sha) {
        if (repoUrl && fullSha) {
          shaHtml = '<a href="' + repoUrl + '/commit/' + fullSha + '" class="sha sha-link" target="_blank" rel="noopener" onclick="event.stopPropagation()">' + sha + '</a>';
        } else {
          shaHtml = '<code class="sha">' + sha + '</code>';
        }
      }

      var statusDot = '';
      if (inProgress) {
        statusDot = '<span class="status-dot status-in-progress" title="In Progress">‚è≥</span>';
      } else if (failed) {
        statusDot = '<span class="status-dot status-fail" title="Failed">‚úó</span>';
      } else {
        statusDot = '<span class="status-dot status-pass" title="Passed">‚úì</span>';
      }

      var versionBadge = '';
      if (b.version) {
        var pillClass = b.badge === 'release' ? 'pill-green' : 'pill-yellow';
        versionBadge = '<span class="pill ' + pillClass + '">' + b.version + '</span>';
      }

      var testBadge = '';
      if (inProgress) {
        testBadge = '<span class="pill pill-in-progress">In Progress</span>';
      } else if (b.tests) {
        var tp = b.tests.passed || 0;
        var tf = (b.tests.failed || 0) + (b.tests.broken || 0);
        if (tp > 0 || tf > 0) {
          var testMsg = tf > 0 ? tp + ' passed, ' + tf + ' failed' : tp + ' passed';
          var testPill = tf > 0 ? 'pill-red' : 'pill-blue';
          testBadge = '<span class="pill ' + testPill + '">' + testMsg + '</span>';
        }
      }

      var prBadge = isPR ? '<span class="pill pill-purple">PR #' + b.pr_number + '</span>' : '';
      var runLabel = isPR ? '#' + b.pr_number : '#' + b.run;
      var authorLine = author ? '<p class="author">by ' + author + (isPR && b.branch ? ' \u00b7 ' + b.branch : '') + '</p>' : '';

      var clickHandler = inProgress ? '' : 'onclick="window.location.href=\'' + b.run + '/\'"';
      return '<div class="' + cardClass + '" style="animation-delay:' + delay + 's" ' + clickHandler + ' role="link" tabindex="0">'
        + '<div class="run">'
        + (runUrl
          ? '<a href="' + runUrl + '" class="run-num run-link" target="_blank" rel="noopener" onclick="event.stopPropagation()" title="View CI pipeline">' + runLabel + '</a>'
          : '<div class="run-num">' + runLabel + '</div>')
        + statusDot
        + '</div>'
        + '<div class="info"><div class="info-top">'
        + prBadge
        + shaHtml
        + testBadge
        + versionBadge
        + '</div><p class="msg">' + (msg || 'No commit message') + '</p>'
        + authorLine
        + '</div>'
        + '<div class="meta">'
        + (date ? '<div class="meta-date">' + date + '</div>' : '')
        + (rel ? '<div class="meta-rel">' + rel + '</div>' : '')
        + '</div>'
        + '</div>';
    }

    function dateLabel(ts) {
      var d = new Date(ts);
      var now = new Date();
      var today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      var target = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      var diff = (today - target) / 86400000;
      var fmtDate = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      if (diff < 1 && diff >= 0) return 'Today \u00b7 ' + fmtDate;
      if (diff >= 1 && diff < 2) return 'Yesterday \u00b7 ' + fmtDate;
      return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
    }


    function renderStats(builds) {
      var now = new Date();
      var todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
      var weekStart = todayStart - 6 * 86400000;
      var monthStart = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

      var completed = builds.filter(function(b) { return b.status !== 'in_progress'; });
      var periods = [
        { label: 'Today', start: todayStart },
        { label: 'This Week', start: weekStart },
        { label: 'This Month', start: monthStart },
        { label: 'All Time', start: 0 }
      ];

      var statsHtml = '<div class="stats-grid">';
      periods.forEach(function(p) {
        var inPeriod = completed.filter(function(b) { return (b.timestamp || 0) >= p.start; });
        var passed = inPeriod.filter(function(b) { return b.passed !== false; });
        var total = inPeriod.length;
        var passCount = passed.length;
        var pct = total > 0 ? Math.round(passCount / total * 100) : 0;
        var pctClass = pct >= 90 ? 'stat-pct good' : pct >= 70 ? 'stat-pct mid' : 'stat-pct low';
        var pctStr = total > 0 ? ' <span class="' + pctClass + '">(' + pct + '%)</span>' : '';

        statsHtml += '<div class="stat-block">'
          + '<div class="stat-label">' + p.label + '</div>'
          + '<div class="stat-value">' + total + ' build' + (total !== 1 ? 's' : '') + '</div>'
          + '<div class="stat-detail">' + passCount + ' passed' + pctStr + '</div>'
          + '</div>';
      });
      statsHtml += '</div>';

      // Contributors
      var authorMap = {};
      completed.forEach(function(b) {
        if (!b.author) return;
        if (!authorMap[b.author]) authorMap[b.author] = { total: 0, passed: 0, monthly: 0, monthlyPassed: 0, builds: [] };
        authorMap[b.author].total++;
        if (b.passed !== false) authorMap[b.author].passed++;
        if ((b.timestamp || 0) >= monthStart) {
          authorMap[b.author].monthly++;
          if (b.passed !== false) authorMap[b.author].monthlyPassed++;
        }
        authorMap[b.author].builds.push(b);
      });

      var authors = Object.keys(authorMap);
      if (authors.length > 0) {
        statsHtml += '<div class="contributors"><div class="contrib-title">Contributors</div>';
        authors.sort(function(a, b) { return authorMap[b].total - authorMap[a].total; });
        authors.forEach(function(name) {
          var a = authorMap[name];
          var sorted = a.builds.slice().sort(function(x, y) { return (y.timestamp || 0) - (x.timestamp || 0); });
          var streak = 0;
          for (var i = 0; i < sorted.length; i++) {
            if (sorted[i].passed === false) break;
            streak++;
          }
          statsHtml += '<div class="contrib-row">'
            + '<span class="contrib-name">' + name + '</span>'
            + '<span class="contrib-sep">\u00b7</span>'
            + '<span class="contrib-detail">' + a.monthly + ' builds this month \u00b7 ' + a.monthlyPassed + ' passed</span>'
            + (streak >= 2 ? '<span class="contrib-sep">\u00b7</span><span class="contrib-streak">\ud83d\udd25 ' + streak + ' streak</span>' : '')
            + '</div>';
        });
        statsHtml += '</div>';
      }

      var el = document.getElementById('stats');
      el.innerHTML = statsHtml;
      el.classList.add('show');
    }

    Promise.all([
      fetch('builds.json').then(function(r) { return r.ok ? r.json() : []; }).catch(function() { return []; }),
      fetch('pr-builds.json').then(function(r) { return r.ok ? r.json() : []; }).catch(function() { return []; })
    ]).then(function(results) {
      var builds = results[0].concat(results[1]).sort(function(a, b) {
        return (b.timestamp || 0) - (a.timestamp || 0);
      });
      var el = document.getElementById('builds');
      if (!builds.length) { document.getElementById('empty').classList.add('show'); return; }
      var html = '';
      var lastGroup = '';
      builds.forEach(function(b, i) {
        if (b.timestamp) {
          var group = dateLabel(b.timestamp);
          if (group !== lastGroup) {
            html += '<div class="date-group">' + group + '</div>';
            lastGroup = group;
          }
        }
        html += renderBuild(b, i);
      });
      el.innerHTML = html;
    }).catch(function() { document.getElementById('empty').classList.add('show'); });
  </script>
</body>
</html>
